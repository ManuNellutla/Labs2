; Version 3.0 - Trade Record with Account Balance Check
; Keywords: SET, KILL, WRITE, QUIT, NEW, IF, $D, $GET
NEW
TRADE3(TRADEID,SYMBOL,QUANTITY,PRICE,ACCOUNT) ; Trade with balance validation
 NEW BALANCE,TOTALCOST
 IF TRADEID=""!(SYMBOL="")!(QUANTITY<=0)!(PRICE<=0)!(ACCOUNT="") QUIT 0
 SET TOTALCOST=QUANTITY*PRICE
 SET BALANCE=$GET(^ACCOUNT(ACCOUNT,"BALANCE"),0)
 IF BALANCE<TOTALCOST WRITE "Error: Insufficient funds in account ",ACCOUNT,! QUIT 0
 SET ^TRADE(TRADEID)="SYMBOL^QUANTITY^PRICE^ACCOUNT"
 SET ^TRADE(TRADEID,"SYMBOL")=SYMBOL
 SET ^TRADE(TRADEID,"QUANTITY")=QUANTITY
 SET ^TRADE(TRADEID,"PRICE")=PRICE
 SET ^TRADE(TRADEID,"ACCOUNT")=ACCOUNT
 SET ^ACCOUNT(ACCOUNT,"BALANCE")=BALANCE-TOTALCOST
 WRITE "Trade executed for ID: ",TRADEID,". New balance: ",^ACCOUNT(ACCOUNT,"BALANCE"),!
 QUIT 1
CANCEL3(TRADEID) ; Cancel trade and refund
 IF '$D(^TRADE(TRADEID)) QUIT 0
 NEW ACCOUNT,QUANTITY,PRICE,TOTALCOST
 SET ACCOUNT=$GET(^TRADE(TRADEID,"ACCOUNT"))
 SET QUANTITY=$GET(^TRADE(TRADEID,"QUANTITY"))
 SET PRICE=$GET(^TRADE(TRADEID,"PRICE"))
 SET TOTALCOST=QUANTITY*PRICE
 SET ^ACCOUNT(ACCOUNT,"BALANCE")=$GET(^ACCOUNT(ACCOUNT,"BALANCE"),0)+TOTALCOST
 KILL ^TRADE(TRADEID)
 WRITE "Trade ",TRADEID," cancelled. Refunded: ",TOTALCOST,!
 QUIT 1
